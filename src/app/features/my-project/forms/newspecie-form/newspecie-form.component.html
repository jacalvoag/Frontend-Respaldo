<div class="modal-overlay" (click)="onOverlayClick($event)">
    <div class="modal-container">
        <div class="modal-header">
            <h2>{{ isEditMode ? 'Editar especie' : 'Nueva especie' }}</h2>
            <button class="close-button" (click)="onClose()">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
                    <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </button>
        </div>

        <form [formGroup]="speciesForm" (submit)="onSubmit()" class="modal-form">
            <div class="form-group">
                <label for="speciesName">Nombre común *</label>
                <input 
                    id="speciesName" 
                    class="form-input" 
                    formControlName="speciesName" 
                    type="text"
                    placeholder="Ej: Corazón Bonito">
            </div>

            <div class="form-group">
                <label for="numberOfIndividuals">Número de individuos *</label>
                <input 
                    id="numberOfIndividuals" 
                    class="form-input" 
                    formControlName="numberOfIndividuals" 
                    type="number"
                    placeholder="Ej: 20">
            </div>

            <div class="form-group">
                <label for="functionalType">Tipo funcional *</label>
                <select 
                    id="functionalType" 
                    class="form-select" 
                    formControlName="functionalType">
                    <option value="" disabled>Seleccione una opción</option>
                    @for (type of functionalTypes; track type) {
                        <option [value]="type">{{ type }}</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label for="samplingUnit">Unidad de muestreo *</label>
                <input 
                    id="samplingUnit" 
                    class="form-input" 
                    formControlName="samplingUnit" 
                    type="text"
                    placeholder="Ej: 10 m²">
            </div>

            <div class="form-group">
                <label for="heightOrStratum">Altura o estrato *</label>
                <input 
                    id="heightOrStratum" 
                    class="form-input" 
                    formControlName="heightOrStratum" 
                    type="text"
                    placeholder="Ej: 10 - 20m">
            </div>

            <div class="image-upload-section">
                <input 
                    type="file" 
                    id="imageInput" 
                    accept="image/*"
                    (change)="onFileSelected($event)"
                    style="display: none;">

                @if (!imagePreview) {
                    <button 
                        type="button" 
                        class="image-upload-button"
                        (click)="triggerFileInput()">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
                            <path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h360v80H200v560h560v-360h80v360q0 33-23.5 56.5T760-120H200Zm120-160h320L553-408 448-272l-65-87-63 79Zm440-320v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80Z"/>
                        </svg>
                        Agregar imagen
                    </button>
                    <p class="image-upload-note">JPG, PNG, GIF o WEBP (máx. 5MB)</p>
                } @else {
                    <div class="image-preview-container">
                        <img [src]="imagePreview" alt="Preview" class="image-preview">
                        <button 
                            type="button" 
                            class="remove-image-button"
                            (click)="removeImage()"
                            [disabled]="uploading">
                            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
                                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                            </svg>
                        </button>
                        
                        @if (uploading) {
                            <div class="uploading-overlay">
                                <div class="spinner"></div>
                                <p>Subiendo...</p>
                            </div>
                        }
                    </div>
                    
                    @if (imageUrl && !uploading) {
                        <p class="upload-success">Imagen guardada exitosamente</p>
                    }
                }

                @if (uploadError) {
                    <p class="upload-error">❌ {{ uploadError }}</p>
                }
            </div>

            <div class="modal-actions">
                <button 
                    type="button" 
                    class="button-modal-action button-modal-action--gray" 
                    (click)="onClose()">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    class="button-modal-action button-modal-action--elverde"
                    [disabled]="!speciesForm.valid">
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>